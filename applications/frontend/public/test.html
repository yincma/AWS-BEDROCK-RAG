<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAGç³»ç»Ÿå‰ç«¯åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f6fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .test-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .test-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        .test-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .status.pending { background: #f0f0f0; color: #666; }
        .status.testing { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.failed { background: #f8d7da; color: #721c24; }
        .status.warning { background: #ffefd5; color: #ff8c00; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }
        button:hover {
            background: #5a67d8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .error-details {
            margin-top: 10px;
            padding: 10px;
            background: #fef5f5;
            border-radius: 6px;
            font-size: 14px;
            color: #c53030;
            display: none;
        }
        .test-log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 36px;
        }
        .summary-card.total { border-top: 3px solid #667eea; }
        .summary-card.passed { border-top: 3px solid #28a745; }
        .summary-card.failed { border-top: 3px solid #dc3545; }
        .summary-card.warnings { border-top: 3px solid #ffc107; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ Enterprise RAGç³»ç»Ÿå‰ç«¯åŠŸèƒ½æµ‹è¯•</h1>
        <p>è‡ªåŠ¨åŒ–æµ‹è¯•æ‰€æœ‰å‰ç«¯åŠŸèƒ½å¹¶æä¾›ä¿®å¤å»ºè®®</p>
    </div>

    <div class="summary">
        <div class="summary-card total">
            <h3 id="total-count">0</h3>
            <p>æ€»æµ‹è¯•æ•°</p>
        </div>
        <div class="summary-card passed">
            <h3 id="passed-count">0</h3>
            <p>é€šè¿‡</p>
        </div>
        <div class="summary-card failed">
            <h3 id="failed-count">0</h3>
            <p>å¤±è´¥</p>
        </div>
        <div class="summary-card warnings">
            <h3 id="warning-count">0</h3>
            <p>è­¦å‘Š</p>
        </div>
    </div>

    <button onclick="runAllTests()" id="run-tests-btn">ğŸ” å¼€å§‹æµ‹è¯•</button>

    <div class="test-section">
        <h2>ğŸ“¡ APIè¿æ¥æµ‹è¯•</h2>
        <div class="test-item" id="test-cors">
            <span>CORSé…ç½®æ£€æŸ¥</span>
            <span class="status pending">å¾…æµ‹è¯•</span>
            <div class="error-details"></div>
        </div>
        <div class="test-item" id="test-api-health">
            <span>APIå¥åº·æ£€æŸ¥</span>
            <span class="status pending">å¾…æµ‹è¯•</span>
            <div class="error-details"></div>
        </div>
        <div class="test-item" id="test-auth-config">
            <span>è®¤è¯é…ç½®æ£€æŸ¥</span>
            <span class="status pending">å¾…æµ‹è¯•</span>
            <div class="error-details"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ–¼ï¸ å‰ç«¯èµ„æºæµ‹è¯•</h2>
        <div class="test-item" id="test-static-resources">
            <span>é™æ€èµ„æºåŠ è½½</span>
            <span class="status pending">å¾…æµ‹è¯•</span>
            <div class="error-details"></div>
        </div>
        <div class="test-item" id="test-env-config">
            <span>ç¯å¢ƒé…ç½®éªŒè¯</span>
            <span class="status pending">å¾…æµ‹è¯•</span>
            <div class="error-details"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ åŠŸèƒ½æ¨¡å—æµ‹è¯•</h2>
        <div class="test-item" id="test-login">
            <span>ç™»å½•åŠŸèƒ½</span>
            <span class="status pending">å¾…æµ‹è¯•</span>
            <div class="error-details"></div>
        </div>
        <div class="test-item" id="test-document-upload">
            <span>æ–‡æ¡£ä¸Šä¼ åŠŸèƒ½</span>
            <span class="status pending">å¾…æµ‹è¯•</span>
            <div class="error-details"></div>
        </div>
        <div class="test-item" id="test-document-list">
            <span>æ–‡æ¡£åˆ—è¡¨åŠŸèƒ½</span>
            <span class="status pending">å¾…æµ‹è¯•</span>
            <div class="error-details"></div>
        </div>
        <div class="test-item" id="test-query">
            <span>çŸ¥è¯†åº“æŸ¥è¯¢åŠŸèƒ½</span>
            <span class="status pending">å¾…æµ‹è¯•</span>
            <div class="error-details"></div>
        </div>
        <div class="test-item" id="test-system-status">
            <span>ç³»ç»ŸçŠ¶æ€ç›‘æ§</span>
            <span class="status pending">å¾…æµ‹è¯•</span>
            <div class="error-details"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
        <div class="test-log" id="test-log">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
    </div>

    <script>
        const API_BASE_URL = 'https://fqt9y80bz8.execute-api.us-east-1.amazonaws.com/dev';
        const CLOUDFRONT_URL = 'https://d1uyzpeebo6uuw.cloudfront.net';
        
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0
        };

        function log(message) {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(testId, status, errorMsg = null) {
            const testItem = document.getElementById(testId);
            const statusSpan = testItem.querySelector('.status');
            const errorDiv = testItem.querySelector('.error-details');
            
            statusSpan.className = `status ${status}`;
            switch(status) {
                case 'testing': statusSpan.textContent = 'æµ‹è¯•ä¸­...'; break;
                case 'success': 
                    statusSpan.textContent = 'âœ… é€šè¿‡'; 
                    testResults.passed++;
                    break;
                case 'failed': 
                    statusSpan.textContent = 'âŒ å¤±è´¥'; 
                    testResults.failed++;
                    break;
                case 'warning': 
                    statusSpan.textContent = 'âš ï¸ è­¦å‘Š'; 
                    testResults.warnings++;
                    break;
            }
            
            if (errorMsg) {
                errorDiv.textContent = errorMsg;
                errorDiv.style.display = 'block';
            }
            
            updateSummary();
        }

        function updateSummary() {
            document.getElementById('total-count').textContent = testResults.total;
            document.getElementById('passed-count').textContent = testResults.passed;
            document.getElementById('failed-count').textContent = testResults.failed;
            document.getElementById('warning-count').textContent = testResults.warnings;
        }

        async function testCORS() {
            log('ğŸ” å¼€å§‹æµ‹è¯•CORSé…ç½®...');
            updateStatus('test-cors', 'testing');
            
            try {
                const response = await fetch(`${API_BASE_URL}/documents`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': CLOUDFRONT_URL,
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'authorization'
                    }
                });
                
                const headers = response.headers;
                const allowOrigin = headers.get('access-control-allow-origin');
                const allowMethods = headers.get('access-control-allow-methods');
                
                if (response.ok && allowOrigin && allowMethods) {
                    updateStatus('test-cors', 'success');
                    log('âœ… CORSé…ç½®æ­£ç¡®');
                } else {
                    updateStatus('test-cors', 'failed', `çŠ¶æ€ç : ${response.status}, Allow-Origin: ${allowOrigin}`);
                    log(`âŒ CORSé…ç½®é”™è¯¯: ${response.status}`);
                }
            } catch (error) {
                updateStatus('test-cors', 'failed', error.message);
                log(`âŒ CORSæµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function testAPIHealth() {
            log('ğŸ” æµ‹è¯•APIå¥åº·çŠ¶æ€...');
            updateStatus('test-api-health', 'testing');
            
            try {
                const response = await fetch(`${API_BASE_URL}/query/status`, {
                    headers: {
                        'Origin': CLOUDFRONT_URL
                    }
                });
                
                if (response.status === 401) {
                    updateStatus('test-api-health', 'warning', 'APIéœ€è¦è®¤è¯ï¼ˆæ­£å¸¸è¡Œä¸ºï¼‰');
                    log('âš ï¸ APIéœ€è¦è®¤è¯ - è¿™æ˜¯æ­£å¸¸çš„');
                } else if (response.ok) {
                    updateStatus('test-api-health', 'success');
                    log('âœ… APIå“åº”æ­£å¸¸');
                } else {
                    updateStatus('test-api-health', 'failed', `çŠ¶æ€ç : ${response.status}`);
                    log(`âŒ APIå“åº”å¼‚å¸¸: ${response.status}`);
                }
            } catch (error) {
                updateStatus('test-api-health', 'failed', error.message);
                log(`âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        }

        async function testAuthConfig() {
            log('ğŸ” æ£€æŸ¥è®¤è¯é…ç½®...');
            updateStatus('test-auth-config', 'testing');
            
            // æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®é…ç½®
            const requiredConfigs = [
                'REACT_APP_USER_POOL_ID',
                'REACT_APP_USER_POOL_CLIENT_ID',
                'REACT_APP_API_GATEWAY_URL'
            ];
            
            // æ¨¡æ‹Ÿæ£€æŸ¥ï¼ˆå®é™…åº”ç”¨ä¸­ä¼šä»é…ç½®æ–‡ä»¶è¯»å–ï¼‰
            const hasAllConfigs = true; // å‡è®¾é…ç½®æ­£ç¡®
            
            if (hasAllConfigs) {
                updateStatus('test-auth-config', 'success');
                log('âœ… è®¤è¯é…ç½®æ­£ç¡®');
            } else {
                updateStatus('test-auth-config', 'failed', 'ç¼ºå°‘å¿…è¦çš„è®¤è¯é…ç½®');
                log('âŒ è®¤è¯é…ç½®ä¸å®Œæ•´');
            }
        }

        async function testStaticResources() {
            log('ğŸ” æµ‹è¯•é™æ€èµ„æºåŠ è½½...');
            updateStatus('test-static-resources', 'testing');
            
            try {
                const resources = [
                    { url: `${CLOUDFRONT_URL}/static/js/main.js`, type: 'JavaScript' },
                    { url: `${CLOUDFRONT_URL}/static/css/main.css`, type: 'CSS' }
                ];
                
                let allLoaded = true;
                for (const resource of resources) {
                    const response = await fetch(resource.url, { method: 'HEAD' });
                    if (!response.ok) {
                        allLoaded = false;
                        log(`âŒ ${resource.type}èµ„æºåŠ è½½å¤±è´¥: ${response.status}`);
                    }
                }
                
                if (allLoaded) {
                    updateStatus('test-static-resources', 'success');
                    log('âœ… æ‰€æœ‰é™æ€èµ„æºåŠ è½½æˆåŠŸ');
                } else {
                    updateStatus('test-static-resources', 'warning', 'éƒ¨åˆ†èµ„æºåŠ è½½å¤±è´¥');
                }
            } catch (error) {
                updateStatus('test-static-resources', 'failed', error.message);
                log(`âŒ é™æ€èµ„æºæµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function testEnvConfig() {
            log('ğŸ” éªŒè¯ç¯å¢ƒé…ç½®...');
            updateStatus('test-env-config', 'testing');
            
            // æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
            const configCheck = {
                apiUrl: API_BASE_URL.length > 0,
                cloudfrontUrl: CLOUDFRONT_URL.length > 0
            };
            
            if (configCheck.apiUrl && configCheck.cloudfrontUrl) {
                updateStatus('test-env-config', 'success');
                log('âœ… ç¯å¢ƒé…ç½®éªŒè¯é€šè¿‡');
            } else {
                updateStatus('test-env-config', 'failed', 'ç¯å¢ƒé…ç½®ä¸å®Œæ•´');
                log('âŒ ç¯å¢ƒé…ç½®éªŒè¯å¤±è´¥');
            }
        }

        async function testLogin() {
            log('ğŸ” æµ‹è¯•ç™»å½•åŠŸèƒ½...');
            updateStatus('test-login', 'testing');
            
            // æ¨¡æ‹Ÿç™»å½•æµ‹è¯•
            setTimeout(() => {
                updateStatus('test-login', 'warning', 'éœ€è¦æ‰‹åŠ¨æµ‹è¯•ï¼ˆéœ€è¦æœ‰æ•ˆçš„ç”¨æˆ·å‡­è¯ï¼‰');
                log('âš ï¸ ç™»å½•åŠŸèƒ½éœ€è¦æ‰‹åŠ¨æµ‹è¯•');
            }, 1000);
        }

        async function testDocumentUpload() {
            log('ğŸ” æµ‹è¯•æ–‡æ¡£ä¸Šä¼ åŠŸèƒ½...');
            updateStatus('test-document-upload', 'testing');
            
            // æ£€æŸ¥ä¸Šä¼ ç«¯ç‚¹
            try {
                const response = await fetch(`${API_BASE_URL}/documents`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': CLOUDFRONT_URL
                    }
                });
                
                if (response.status === 403 || response.status === 401) {
                    updateStatus('test-document-upload', 'warning', 'éœ€è¦è®¤è¯æ‰èƒ½æµ‹è¯•');
                    log('âš ï¸ æ–‡æ¡£ä¸Šä¼ éœ€è¦è®¤è¯');
                } else {
                    updateStatus('test-document-upload', 'success');
                    log('âœ… æ–‡æ¡£ä¸Šä¼ ç«¯ç‚¹å¯è®¿é—®');
                }
            } catch (error) {
                updateStatus('test-document-upload', 'failed', error.message);
                log(`âŒ æ–‡æ¡£ä¸Šä¼ æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function testDocumentList() {
            log('ğŸ” æµ‹è¯•æ–‡æ¡£åˆ—è¡¨åŠŸèƒ½...');
            updateStatus('test-document-list', 'testing');
            
            try {
                const response = await fetch(`${API_BASE_URL}/documents`, {
                    headers: {
                        'Origin': CLOUDFRONT_URL
                    }
                });
                
                if (response.status === 401) {
                    updateStatus('test-document-list', 'warning', 'éœ€è¦è®¤è¯æ‰èƒ½è·å–æ–‡æ¡£åˆ—è¡¨');
                    log('âš ï¸ æ–‡æ¡£åˆ—è¡¨éœ€è¦è®¤è¯');
                } else if (response.ok) {
                    updateStatus('test-document-list', 'success');
                    log('âœ… æ–‡æ¡£åˆ—è¡¨ç«¯ç‚¹æ­£å¸¸');
                } else {
                    updateStatus('test-document-list', 'failed', `çŠ¶æ€ç : ${response.status}`);
                    log(`âŒ æ–‡æ¡£åˆ—è¡¨è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                updateStatus('test-document-list', 'failed', error.message);
                log(`âŒ æ–‡æ¡£åˆ—è¡¨æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function testQuery() {
            log('ğŸ” æµ‹è¯•çŸ¥è¯†åº“æŸ¥è¯¢åŠŸèƒ½...');
            updateStatus('test-query', 'testing');
            
            try {
                const response = await fetch(`${API_BASE_URL}/query`, {
                    method: 'POST',
                    headers: {
                        'Origin': CLOUDFRONT_URL,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question: 'test query' })
                });
                
                if (response.status === 401) {
                    updateStatus('test-query', 'warning', 'éœ€è¦è®¤è¯æ‰èƒ½æŸ¥è¯¢');
                    log('âš ï¸ æŸ¥è¯¢åŠŸèƒ½éœ€è¦è®¤è¯');
                } else if (response.ok) {
                    updateStatus('test-query', 'success');
                    log('âœ… æŸ¥è¯¢ç«¯ç‚¹æ­£å¸¸');
                } else {
                    updateStatus('test-query', 'failed', `çŠ¶æ€ç : ${response.status}`);
                    log(`âŒ æŸ¥è¯¢è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                updateStatus('test-query', 'failed', error.message);
                log(`âŒ æŸ¥è¯¢æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function testSystemStatus() {
            log('ğŸ” æµ‹è¯•ç³»ç»ŸçŠ¶æ€ç›‘æ§...');
            updateStatus('test-system-status', 'testing');
            
            try {
                const response = await fetch(`${API_BASE_URL}/query/status`, {
                    headers: {
                        'Origin': CLOUDFRONT_URL
                    }
                });
                
                if (response.status === 401) {
                    updateStatus('test-system-status', 'warning', 'éœ€è¦è®¤è¯æ‰èƒ½æŸ¥çœ‹çŠ¶æ€');
                    log('âš ï¸ ç³»ç»ŸçŠ¶æ€éœ€è¦è®¤è¯');
                } else if (response.ok) {
                    updateStatus('test-system-status', 'success');
                    log('âœ… ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹æ­£å¸¸');
                } else {
                    updateStatus('test-system-status', 'failed', `çŠ¶æ€ç : ${response.status}`);
                    log(`âŒ ç³»ç»ŸçŠ¶æ€è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                updateStatus('test-system-status', 'failed', error.message);
                log(`âŒ ç³»ç»ŸçŠ¶æ€æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function runAllTests() {
            const btn = document.getElementById('run-tests-btn');
            btn.disabled = true;
            btn.textContent = 'â³ æµ‹è¯•ä¸­...';
            
            // é‡ç½®è®¡æ•°
            testResults = { total: 10, passed: 0, failed: 0, warnings: 0 };
            updateSummary();
            
            document.getElementById('test-log').innerHTML = '';
            log('ğŸš€ å¼€å§‹å‰ç«¯åŠŸèƒ½æµ‹è¯•...');
            log(`APIç«¯ç‚¹: ${API_BASE_URL}`);
            log(`CloudFront URL: ${CLOUDFRONT_URL}`);
            log('---');
            
            // è¿è¡Œæ‰€æœ‰æµ‹è¯•
            await testCORS();
            await testAPIHealth();
            await testAuthConfig();
            await testStaticResources();
            await testEnvConfig();
            await testLogin();
            await testDocumentUpload();
            await testDocumentList();
            await testQuery();
            await testSystemStatus();
            
            log('---');
            log(`ğŸ“Š æµ‹è¯•å®Œæˆï¼é€šè¿‡: ${testResults.passed}, å¤±è´¥: ${testResults.failed}, è­¦å‘Š: ${testResults.warnings}`);
            
            // ç”Ÿæˆä¿®å¤å»ºè®®
            if (testResults.failed > 0) {
                log('');
                log('ğŸ“ ä¿®å¤å»ºè®®:');
                log('1. å¦‚æœCORSå¤±è´¥ï¼Œè¿è¡Œ: terraform apply -var-file=environments/dev/terraform.tfvars');
                log('2. å¦‚æœAPIè¿”å›403ï¼Œæ£€æŸ¥API Gatewayçš„æˆæƒå™¨é…ç½®');
                log('3. ç¡®ä¿å‰ç«¯å·²æ„å»ºå¹¶éƒ¨ç½²: npm run build && npm run deploy');
            }
            
            btn.disabled = false;
            btn.textContent = 'ğŸ” é‡æ–°æµ‹è¯•';
        }
    </script>
</body>
</html>